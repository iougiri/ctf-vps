---

- hosts: localhost
  become: true
  pre_tasks:
    
  - name: update cache
    tags: always
    apt:
      update_cache: yes

- hosts: localhost
  become: true
  tasks:

  - name: add Kali archive key
    tags: init, kali
    apt_key:
      url: https://archive.kali.org/archive-key.asc
      state: present

  - name: replace all entries in sources.list with Kali
    tags: init, kali
    copy:
      src: sources.list
      dest: /etc/apt/sources.list
      owner: root
      group: root
      mode: 0644

  - name: dist upgrade to Kali
    tags: init, kali
    apt:
      upgrade: dist
      update_cache: yes

  - name: install basic packages
    tags: init, basic
    package:
      name:
        - apt-transport-https
        - curl
        - ftp
        - git
        - grep
        - htop
        - jq
        - mariadb-client
        - mkpasswd
        - openssh-client
        - rsync
        - tar
        - tmux
        - traceroute
        - unzip
        - vim
        - wget
      state: latest

  - name: install programming languages
    tags: ctf, programming, basic
    apt:
      name:
        - golang
        - python2
        - python3
        - python3-impacket
        - python3-pip
        - python3-venv

  - name: install CTF packages
    tags: ctf, kali
    apt:
      name:
        - dnsutils
        - ffuf
        - gobuster
        - hashcat
        - hydra
        - john
        - metasploit-framework
        - nmap
        - ripgrep
        - silversearcher-ag
        - sqlmap
        - wpscan
      state: latest

- hosts: localhost
  become: true
  
  tasks:

  - name: create directories in /opt
    tags: ctf, filesystem, opt
    file:
      path: "/opt/{{ item }}"
      state: directory
      mode: '0755'
      owner: root
      group: root
    loop:
      - tools
      - wordlists

  - name: clone Github repos
    tags: ctf, github, wordlists, opt
    git:
      repo: "{{ item.repo }}"
      dest: "/opt/{{ item.dir_name }}"
      update: no
    loop:
      - {dir_name: "wordlists/SecLists", repo: "https://github.com/danielmiessler/SecLists.git"}
    loop_control:
      label: "{{ item.dir_name }}"

  - name: unpack rockyou.txt
    tags: wordlists
    unarchive:
      src: /opt/wordlists/SecLists/Passwords/Leaked-Databases/rockyou.txt.tar.gz
      dest: /opt/wordlists/SecLists/Passwords/Leaked-Databases
      
  - name: install Go packages
    tags: ctf, go, packages
    environment:
      GOPATH: "/usr/local/go"
    command: go install "{{ item }}"
    loop:
      - github.com/tomnomnom/anew@latest
    loop_control:
      label: "{{ item }}"

  - name: download packages manually
    tags: ctf, packages, manualdownloads, opt
    get_url:
      url: "{{ item.url }}"
      dest: "{{ item.path }}"
    loop: 
      - {path: "/opt/tools/pspy64", url: "https://github.com/DominicBreuker/pspy/releases/download/v1.2.0/pspy64"}
      - {path: "/tmp/chisel_amd64.gz", url: "https://github.com/jpillora/chisel/releases/download/v1.7.7/chisel_1.7.7_linux_amd64.gz"}
      - {path: "/tmp/chisel_win_amd64.gz", url: "https://github.com/jpillora/chisel/releases/download/v1.7.7/chisel_1.7.7_windows_amd64.gz"}
    loop_control:
      label: "{{ item.url }}"

  - name: unzip files
    tags: ctf, packages, manualdownloads, opt
    shell: "gunzip -c {{ item.src }} > {{ item.dest }}"
    args:
      creates: "{{ item.dest }}"
    loop:
      - {src: "/tmp/chisel_amd64.gz", dest: "/opt/tools/chisel"}
      - {src: "/tmp/chisel_win_amd64.gz", dest: "/opt/tools/chisel_win"}
    loop_control:
      label: "{{ item.dest }}"

- hosts: localhost
  become: true
  
  tasks:

  - name: create user account
    tags: user
    user:
      name: '{{ lookup("env", "ANSIBLE_USER") }}'
      uid: 1000
      shell: /bin/bash
      groups: sudo
      password: '{{ lookup("env", "ANSIBLE_USERPASS") }}'

  - name: add public key to authorized_keys
    tags: user, ssh
    authorized_key:
      user: '{{ lookup("env", "ANSIBLE_USER") }}'
      key: '{{ lookup("env", "ANSIBLE_PUBKEY") }}'

  - name: hardening sshd
    tags: ssh
    block:
      - name: editing sshd config
        lineinfile:
          dest: "/etc/ssh/sshd_config"
          regexp: "{{ item.regexp | default(omit) }}"
          line: "{{ item.line }}"
          state: "{{ item.state | default('present') }}"
          validate: "sshd -t -f %s"
        with_items:
          - line: "Protocol 2"
          - line: "Protocol 1"
            state: "absent"
          - line: "RSAAuthentication yes"
            state: "absent"
          - regexp: "^PermitRootLogin\ "
            line: "PermitRootLogin no"
          - regexp: "^PasswordAuthentication\ "
            line: "PasswordAuthentication no"
          - regexp: "^PermitEmptyPasswords\ "
            line: "PermitEmptyPasswords no"
          - regexp: "^KexAlgorithms\ "
            line: "KexAlgorithms curve25519-sha256@libssh.org,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256"
          - regexp: "^Ciphers\ "
            line: "Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr"
          - regexp: "^MACs\ "
            line: "MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com"

        notify:
          - restart sshd

  handlers:
    - name: restart sshd
      service: name=sshd state=restarted

